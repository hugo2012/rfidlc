sap.ui.define(["com/bosch/rbf0/lo/rfidlc/controller/BaseController","sap/ui/model/json/JSONModel","sap/ui/core/ws/SapPcpWebSocket","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageBox","sap/m/InstanceManager","sap/m/MessageToast","com/bosch/rbf0/lo/rfidlc/model/formatter"],function(e,t,o,i,s,a,r,n,l){"use strict";return e.extend("com.bosch.rbf0.lo.rfidlc.controller.Monitor",{formatter:l,_sGate:null,_sLoadNumber:null,_iCountLeft:0,_iCountTotal:0,_isRefresh:1,_oWebSocket:null,_sCloseReason:"NAVBACK",_iCloseCode:1e3,_oLeftTable:null,_oMiddleTable:null,_oRightTable:null,_oViewModel:null,_sError:"#fbdfdf",_sWarning:"#fef0db",_sSuccess:"#e0f1e7",_oDialog:null,onInit:function(){this._oLeftTable=this.byId("idStatusTable");this._oMiddleTable=this.byId("idMiddle");this._oRightTable=this.byId("idErrorTable");this._oDummyLeftTable=this.byId("oDummyLeftTable");this._oDummyMiddleTable=this.byId("oDummyMiddleTable");this._oDummyRightTable=this.byId("oDummyRightTable");this.getRouter().getRoute("monitor").attachPatternMatched(this._onMonitorMatched,this)},_onMonitorMatched:function(e){var o=new t({WarehouseNo:"",Gate:"",CountCurrent:0,CountTotal:0,LeftTableCount:0,CenterTableCount:0,errorFound:false,ErrorTableCount:0,cancelLabel:sap.ui.getCore().getLibraryResourceBundle("sap.m").getText("MESSAGEPOPOVER_CLOSE"),bLockMonitor:false,sPhoto:null,iPicHeight:"100px",PGI:{percentage:0,displayText:""}});this.setModel(o,"monitorView");this._oViewModel=o;this._resetView();this._createBackgroundColor();var i=e.getParameter("arguments");this.getOwnerComponent().getModel().metadataLoaded().then(function(){if(i.hasOwnProperty("WarehouseNo")&&i.hasOwnProperty("gate")){this._oViewModel.setProperty("/WarehouseNo",i.WarehouseNo);this._oViewModel.setProperty("/Gate",i.gate);window.setTimeout(function(){this.initAbapChannel();this.getLocalStorage()}.bind(this),100)}else{this.onNavButtonPress()}}.bind(this))},onNavButtonPress:function(){this._isRefresh=0;if(this._oWebSocket!==null){this._oWebSocket.close(this._iCloseCode,this._sCloseReason);this._oWebSocket=null}e.prototype.onNavBack.call(this)},_bindHeader:function(){var e=this.getView(),t=this._oViewModel.getProperty("/Gate"),o=this._oViewModel.getProperty("/WarehouseNo"),i=this.getModel().createKey("/HeaderLineSet",{WarehouseNo:o,Gate:t}),s=e.getElementBinding(),a;if(s!==undefined){a=s.getPath();if(a===i){s.refresh(true);return}}e.bindElement(i)},_bindHeaderPreviousSession:function(){var e=this.getView(),t=this._oViewModel.getProperty("/Gate"),o=this._oViewModel.getProperty("/WarehouseNo"),i=this.getModel().createKey("/HeaderLineSet",{WarehouseNo:o,Gate:t}),s=e.getElementBinding(),a;if(s!==undefined){a=s.getPath();if(a===i){s.refresh(true);return}}e.bindElement(i)},_unbindHeader:function(){var e=this.getView();e.unbindElement()},truckIconLeft:function(e){if(e===true){return"sap-icon://arrow-right"}else if(e===false){return"sap-icon://arrow-left"}else{return""}},firstDigits:function(e){if(e.indexOf("DUMMY")!==-1){return""}var t=e.length,o=t-5,i=e.substring(0,o);return i},lastDigits:function(e){if(e.indexOf("DUMMY")!==-1){return""}var t=e.length,o=t-5,i=e.substring(o);return i},dateConverter:function(e){var t=new Intl.DateTimeFormat("en-GB",{day:"2-digit",month:"2-digit",year:"numeric"});var o=t.format(e);return o},timeConverter:function(e){function t(e){var t=parseInt(e%1e3/100),o=Math.floor(e/1e3%60),i=Math.floor(e/(1e3*60)%60),s=Math.floor(e/(1e3*60*60)%24);s=s<10?"0"+s:s;i=i<10?"0"+i:i;o=o<10?"0"+o:o;return s+":"+i+":"+o}var o=e.ms;var i=t(o);return i},getLoadNumber:function(e){if(e===null||e===" "){e=this._sLoadNumber}else{if(this._sGate===this._oViewModel.getProperty("/Gate")){if(e===""){e=this._sLoadNumber}else{this._sLoadNumber=e}}else{this._sLoadNumber=e;this._sGate=this._oViewModel.getProperty("/Gate")}}return e},getLocalStorage:function(){this._loadLeftTableItemsPreviousSession();this._loadMiddleTableItems();this._loadRightTableItems()},_loadLeftTableItems:function(){var e=this._oLeftTable,t=e.getBindingInfo("items"),o=this.getModel(),a=this._oViewModel.getProperty("/Gate"),r=this._oViewModel.getProperty("/WarehouseNo"),n=[new i("WarehouseNo",s.EQ,r),new i("Gate",s.EQ,a)];var l=t.path+"/$count";var d=this;var u=this._oDummyLeftTable;var h={dummyLeftRows:[{Value:"|"},{Value:"|"},{Value:"|"},{Value:"|"},{Value:"|"},{Value:"|"},{Value:"|"},{Value:"|"},{Value:"|"},{Value:"|"}]};var g=new sap.ui.model.json.JSONModel;g.setData(h);o.read(l,{filters:n,success:function(e){d._oViewModel.setProperty("/LeftTableCount",e);d._oViewModel.setProperty("/CountCurrent",e);d._iCountLeft=e;if(e>0&&e<10){d.getView().byId("oDummyLeftTable").setVisible(true);h.dummyLeftRows.splice(0,e);g.setData(h);d.getView().setModel(g,"dummyLeftModel");d.getView().byId("oDummyLeftTable").setModel(d.getView().getModel("dummyLeftModel"));u.getBinding("items").getModel().updateBindings(true)}else{d.getView().byId("oDummyLeftTable").setVisible(false)}},error:function(){}});e.bindItems({path:t.path,template:t.template,filters:n,events:{dataRequested:function(){o.metadataLoaded().then(function(){e.setBusy(true)})},dataReceived:function(t){e.setBusy(false)}}})},_loadLeftTableItemsPreviousSession:function(){var e=this._oLeftTable,t=e.getBindingInfo("items"),o=this.getModel(),a=this._oViewModel.getProperty("/Gate"),r=this._oViewModel.getProperty("/WarehouseNo"),n=[new i("WarehouseNo",s.EQ,r),new i("Gate",s.EQ,a)];var l=t.path+"/$count";var d=this;var u=this._oDummyLeftTable;var h={dummyLeftRows:[{Value:"|"},{Value:"|"},{Value:"|"},{Value:"|"},{Value:"|"},{Value:"|"},{Value:"|"},{Value:"|"},{Value:"|"},{Value:"|"}]};var g=new sap.ui.model.json.JSONModel;g.setData(h);o.read(l,{filters:n,success:function(e){d._oViewModel.setProperty("/LeftTableCount",e);d._oViewModel.setProperty("/CountCurrent",e);d._iCountLeft=e;if(e>0&&e<10){d.getView().byId("oDummyLeftTable").setVisible(true);h.dummyLeftRows.splice(0,e);g.setData(h);d.getView().setModel(g,"dummyLeftModel");d.getView().byId("oDummyLeftTable").setModel(d.getView().getModel("dummyLeftModel"));u.getBinding("items").getModel().updateBindings(true)}else{d.getView().byId("oDummyLeftTable").setVisible(false)}},error:function(){}});e.bindItems({path:t.path,template:t.template,filters:n,events:{dataRequested:function(){o.metadataLoaded().then(function(){e.setBusy(true)})},dataReceived:function(t){e.setBusy(false);d._bindHeaderPreviousSession();d.onOpenDialogPreviousSession()}}})},onLeftTableUpdateFinished:function(e){var t=e.getSource();window.setTimeout(function(){var e=t.getItems(),o=false,i=0;for(var s=0;s<e.length;s++){var a=e[s],r=a.getBindingContext(),n=r.getModel(),l=r.getPath(),d=n.getProperty(l);if(d.Status==="G"){a.$().css("background-color",this._sSuccess)}else if(d.Status==="Y"){a.$().css("background-color",this._sWarning)}else{a.$().css("background-color",this._sError);o=true}if(d.Status!=="Y"){i+=1}}if(o){this._enableErrorPane()}else{this._disableErrorPane()}}.bind(this),50)},_enableErrorPane:function(){var e=this.getView().getModel("monitorView");e.setProperty("/errorFound",true)},_disableErrorPane:function(){var e=this.getView().getModel("monitorView");e.setProperty("/errorFound",false)},_loadMiddleTableItems:function(){var e=this._oMiddleTable,t=e.getBindingInfo("items"),o=this.getModel(),a=this._oViewModel.getProperty("/Gate"),r=this._oViewModel.getProperty("/WarehouseNo"),n=[new i("WarehouseNo",s.EQ,r),new i("Gate",s.EQ,a)];var l=t.path+"/$count";var d=0;var u=this;var h=this._oDummyMiddleTable;var g={dummyMiddleRows:[{Value:"|"},{Value:"|"},{Value:"|"},{Value:"|"},{Value:"|"},{Value:"|"},{Value:"|"},{Value:"|"},{Value:"|"},{Value:"|"}]};var c=new sap.ui.model.json.JSONModel;c.setData(g);o.read(l,{filters:n,success:function(e){u._oViewModel.setProperty("/CenterTableCount",e);u._iCountTotal=Number(u._iCountLeft)+Number(e);u._oViewModel.setProperty("/CountTotal",u._iCountTotal);if(e>0&&e<10){u.getView().byId("oDummyMiddleTable").setVisible(true);g.dummyMiddleRows.splice(0,e);c.setData(g);u.getView().setModel(c,"dummyMiddleModel");u.getView().byId("oDummyMiddleTable").setModel(u.getView().getModel("dummyMiddleModel"));h.getBinding("items").getModel().updateBindings(true)}else{u.getView().byId("oDummyMiddleTable").setVisible(false)}},error:function(){}});e.bindItems({path:t.path,template:t.template,filters:n,events:{dataRequested:function(){o.metadataLoaded().then(function(){e.setBusy(true)})},dataReceived:function(t){e.setBusy(false)}}})},onMiddleTableUpdateFinished:function(e){},_loadRightTableItems:function(){var e=this._oRightTable,t=e.getBindingInfo("items"),o=this.getModel(),a=this._oViewModel.getProperty("/Gate"),r=this._oViewModel.getProperty("/WarehouseNo"),n=[new i("WarehouseNo",s.EQ,r),new i("Gate",s.EQ,a)];var l=t.path+"/$count";var d=0;var u=this;var h=this._oDummyRightTable;var g={dummyRightRows:[{Value:"|"},{Value:"|"},{Value:"|"},{Value:"|"},{Value:"|"},{Value:"|"},{Value:"|"},{Value:"|"},{Value:"|"},{Value:"|"}]};var c=new sap.ui.model.json.JSONModel;c.setData(g);o.read(l,{filters:n,success:function(e){u._oViewModel.setProperty("/ErrorTableCount",e);if(e>0&&e<10){u.getView().byId("oDummyRightTable").setVisible(true);g.dummyRightRows.splice(0,e);c.setData(g);u.getView().setModel(c,"dummyRightModel");u.getView().byId("oDummyRightTable").setModel(u.getView().getModel("dummyRightModel"));h.getBinding("items").getModel().updateBindings(true)}else{u.getView().byId("oDummyRightTable").setVisible(false)}},error:function(){}});e.bindItems({path:t.path,template:t.template,filters:n,events:{dataRequested:function(){o.metadataLoaded().then(function(){e.setBusy(true)})},dataReceived:function(t){e.setBusy(false)}}})},onRightTableUpdateFinished:function(e){var t=e.getSource();window.setTimeout(function(){var e=t.getItems();this._oViewModel.setProperty("/ErrorTableCount",e.length);for(var o=0;o<e.length;o++){var i=e[o],s=i.getBindingContext(),a=s.getModel(),r=s.getPath(),n=a.getProperty(r);if(n.Status==="Y"){i.$().css("background-color",this._sWarning)}else{i.$().css("background-color",this._sError)}}}.bind(this),50)},initAbapChannel:function(){var e,t="/sap/bc/apc/rbf0/lo_rfid_load_monitor_apc";try{e=new o(t,o.SUPPORTED_PROTOCOLS.v10);e.attachOpen(function(e){n.show("Websocket connection opened")});e.attachClose(function(e){n.show("Websocket connection closed");var t=e.getParameters();window.setTimeout(function(){if(t.code!==this._iCloseCode||t.reason!==this._sCloseReason){if(this._oWebSocket!==null){this.initAbapChannel()}}}.bind(this),1e3)},this);e.attachMessage(function(e){if(e.getParameter("pcpFields").errorText){return}var t=JSON.parse(e.getParameter("data")),o=this._oViewModel.getProperty("/WarehouseNo"),i=this._oViewModel.getProperty("/Gate");if(t.hasOwnProperty("WarehouseNo")&&t.WarehouseNo===o&&t.hasOwnProperty("GATE")&&t.GATE===i){this._handlePushReceived(t)}},this);this._oWebSocket=e}catch(e){this._oWebSocket=null}},_handlePushReceived:function(e){if(this._oViewModel.getProperty("/bLockMonitor")){if(e.hasOwnProperty("STOPLOAD")&&e.STOPLOAD===""){this.onHandleContinueLoad()}return}r.closeAllDialogs();if(e.hasOwnProperty("HEADERERROR")&&e.HEADERERROR==="X"){this._handleError()}else if(e.hasOwnProperty("LOADINGSTART")&&e.LOADINGSTART==="X"||e.hasOwnProperty("GATECHANGED")&&e.GATECHANGED==="X"){this._resetView();this.onOpenDialog()}else if(e.hasOwnProperty("STOPLOAD")&&e.STOPLOAD==="X"){this.onHandleStopLoad()}else if(e.hasOwnProperty("PICTURESTORED")&&e.PICTURESTORED==="X"){this.onOpenPhotoDialog()}else if(e.hasOwnProperty("HULOADEDWAITFORPIC")&&e.HULOADEDWAITFORPIC==="X"){this.onOpenWaitForPicDialog()}else if(e.hasOwnProperty("USERLOCKSLOAD")&&e.USERLOCKSLOAD==="X"){this.onOpenUserLocksLoad()}else if(e.hasOwnProperty("LOADCOMPLETED")&&e.LOADCOMPLETED==="X"){this.onLoadCompleted()}else if(e.hasOwnProperty("NEWDATAAVAILABLE")&&e.NEWDATAAVAILABLE==="X"){this._loadLeftTableItems();this._loadMiddleTableItems();this._loadRightTableItems();this._bindHeader()}else if(e.hasOwnProperty("POSTGOODSISSUEPROGRESS")&&e.POSTGOODSISSUEPROGRESS==="X"){this._showPostGooodsIssueProgress(e)}else if(e.hasOwnProperty("POSTGOODSISSUEDONE")&&e.POSTGOODSISSUEDONE==="X"){this._showPostGooodsIssueDone()}else if(e.hasOwnProperty("FLAGPIC")){this._showPictureStatus(e.FLAGPIC)}},_handleError:function(){this.getModel().metadataLoaded().then(function(){var e=this._oViewModel.getProperty("/Gate"),t=this._oViewModel.getProperty("/WarehouseNo"),o=this.getModel().createKey("/HeaderLineSet",{WarehouseNo:t,Gate:e});this.getModel().read(o,{success:function(e){a.error(e.ErrorMessage,{styleClass:this.getOwnerComponent().getContentDensityClass(),actions:[sap.m.MessageBox.Action.CLOSE]})}.bind(this),error:function(){}})}.bind(this))},_createBackgroundColor:function(){this.getModel().metadataLoaded().then(function(){window.setTimeout(function(){if(sap.ui.core&&sap.ui.core.theming&&sap.ui.core.theming.Parameters){var e=sap.ui.core.theming.Parameters.get("sapErrorBackground"),t=sap.ui.core.theming.Parameters.get("sapWarningBackground"),o=sap.ui.core.theming.Parameters.get("sapSuccessBackground");if(e){this._sError=e}if(t){this._sWarning=t}if(o){this._sSuccess=o}}}.bind(this),50)}.bind(this))},_resetView:function(){this._unbindHeader();this._oLeftTable.destroyItems();this._oMiddleTable.destroyItems();this._oRightTable.destroyItems();this._oDummyLeftTable.destroyItems();this._oDummyMiddleTable.destroyItems();this._oDummyRightTable.destroyItems()},_getDialog:function(){if(!this._oDialog){this._oDialog=sap.ui.xmlfragment("com.bosch.rbf0.lo.rfidlc.view.fragment.PopupInitialScreen",this);this.getView().addDependent(this._oDialog)}return this._oDialog},onOpenDialog:function(){var e=this._getDialog(),t=this._oViewModel.getProperty("/Gate"),o=this._oViewModel.getProperty("/WarehouseNo"),i=this.getModel().createKey("/HeaderLineSet",{WarehouseNo:o,Gate:t}),s=e.getElementBinding(),a;if(s!==undefined){a=s.getPath();if(a===i){s.refresh(true);e.open();return}}e.bindElement(i);e.open()},onOpenDialogPreviousSession:function(){var e=this._getDialog(),t=this._oViewModel.getProperty("/Gate"),o=this._oViewModel.getProperty("/WarehouseNo"),i=this.getModel().createKey("/HeaderLineSet",{WarehouseNo:o,Gate:t}),s=e.getElementBinding(),a;if(s!==undefined){a=s.getPath();if(a===i){s.refresh(true);if(this._iCountTotal!==0&&this._isRefresh===0){e.open()}else if(this._iCountTotal===0&&(this._isRefresh===0||this._isRefresh===1)){e.open()}return}}e.bindElement(i);if(this._iCountTotal!==0&&this._isRefresh===0){e.open()}else if(this._iCountTotal===0&&(this._isRefresh===0||this._isRefresh===1)){e.open()}},onCloseDialog:function(){this._getDialog().close()},onHandleStopLoad:function(){var e=!!this.getView().$().closest(".sapUiSizeCompact").length,t=this.getResourceBundle().getText("msgStopLoad");a.error(t,{styleClass:e?"sapUiSizeCompact":""});this._oViewModel.setProperty("/bLockMonitor",true)},onHandleContinueLoad:function(){r.closeAllDialogs();var e=!!this.getView().$().closest(".sapUiSizeCompact").length,t=this.getResourceBundle().getText("msgContinueLoad");a.success(t,{styleClass:e?"sapUiSizeCompact":""});this._oViewModel.setProperty("/bLockMonitor",false)},_getPhotoDialog:function(){if(!this._oPhotoDialog){this._oPhotoDialog=sap.ui.xmlfragment("com.bosch.rbf0.lo.rfidlc.view.fragment.PopupPhoto",this);this.getView().addDependent(this._oPhotoDialog)}return this._oPhotoDialog},onOpenPhotoDialog:function(){var e=this._getPhotoDialog(),t=this._oViewModel.getProperty("/Gate"),o=this._oViewModel.getProperty("/WarehouseNo"),i=this.getModel().createKey("/PhotoSet",{WarehouseNo:o,Gate:t}),s=this.getModel().sServiceUrl+i+"/$value";this._oViewModel.setProperty("/sPhoto",s);e.open();window.setTimeout(function(){var e=this._getPhotoDialog(),t=$("#"+e.getId()+"-cont").height();this._oViewModel.setProperty("/iPicHeight",t-2*16+"px")}.bind(this),500)},onClosePhotoDialog:function(){this._getPhotoDialog().close()},onOpenWaitForPicDialog:function(){var e=!!this.getView().$().closest(".sapUiSizeCompact").length,t=this.getResourceBundle().getText("msgWaitForGI");a.information(t,{styleClass:e?"sapUiSizeCompact":""})},onOpenUserLocksLoad:function(){var e=this.getView(),t=e.getElementBinding(),o=t.getPath(),i=this.getModel().getProperty(o),s=i.LoadNumber;var r=!!this.getView().$().closest(".sapUiSizeCompact").length,n=this.getResourceBundle().getText("msgUserLocksLoad",[s]);a.error(n,{styleClass:r?"sapUiSizeCompact":""})},onLoadCompleted:function(){var e=this.getView(),t=e.getElementBinding(),o=t.getPath(),i=this.getModel().getProperty(o),s=i.LoadNumber;var r=!!this.getView().$().closest(".sapUiSizeCompact").length,n=this.getResourceBundle().getText("msgLoadCompleted",[s]);a.information(n,{styleClass:r?"sapUiSizeCompact":""})},_getPostGoodsIssueProgressDialog:function(){if(!this._oPostGoodsIssueProgressDialog){this._oPostGoodsIssueProgressDialog=sap.ui.xmlfragment("com.bosch.rbf0.lo.rfidlc.view.fragment.PopupPostGoodsIssue",this);this.getView().addDependent(this._oPostGoodsIssueProgressDialog)}return this._oPostGoodsIssueProgressDialog},_showPostGooodsIssueProgress:function(e){var t=this._getPostGoodsIssueProgressDialog(),o,i,s,a;if(e.hasOwnProperty("PROCESSED")&&e.hasOwnProperty("TOTAL")){try{o=parseInt(e.PROCESSED,10);i=parseInt(e.TOTAL,10);s=o/i*100;a=Math.round(s);this._oViewModel.setProperty("/PGI/percentage",a);var r=this.getResourceBundle().getText("popupPGImessage",[o,i]);this._oViewModel.setProperty("/PGI/displayText",r);var n=this.getResourceBundle().getText("popupPGIProgressBar",[a]);this._oViewModel.setProperty("/PGI/progressText",n);t.open();window.setTimeout(function(){this._getPostGoodsIssueProgressDialog().getEndButton().focus()}.bind(this),500)}catch(e){return}}},onClosePGIDialog:function(){this._getPostGoodsIssueProgressDialog().close()},_showPostGooodsIssueDone:function(){var e=!!this.getView().$().closest(".sapUiSizeCompact").length,t=this.getResourceBundle().getText("popupMsgPGIDone");a.information(t,{styleClass:e?"sapUiSizeCompact":""})},_showPictureStatus:function(e){var t=null;if(e==="N"||e==="A"){t=this.getResourceBundle().getText("popupMSGFlagPicArchive")}else if(e==="R"||e==="B"){t=this.getResourceBundle().getText("popupMSGFlagPicLoad")}if(t!==null){var o=!!this.getView().$().closest(".sapUiSizeCompact").length;a.information(t,{styleClass:o?"sapUiSizeCompact":""})}}})});
//# sourceMappingURL=Monitor.controller.js.map